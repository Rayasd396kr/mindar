<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v6.1.0/dist/aframe-extras.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@v0.74.0/dist/L.Control.Locate.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.74.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>

    <style>
        #map {
            width: 100%;
            height: 30vh;
            position: absolute;
            bottom: 0px;
            left: 0;
            z-index: 999;
        }
        .fa-map-marker {
            position: relative;
            top: 5px; 
        }
    </style>
  </head>
  
  <body>
    <a-scene mindar-image="uiScanning: #example-scanning-overlay;filterMinCF:0.0001; filterBeta: 0.001;imageTargetSrc: https://raw.githubusercontent.com/Rayasd396kr/ar/main/t3.mind;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: ${customFields.libVersion}; objects: .clickable"></a-camera>
      <a-entity id="bearEntity" mindar-image-target="targetIndex: 0" >
        <a-plane opacity="0.5" color="white" width="10" height="10" position="0 0 0"></a-plane>
        <a-text value="test" color="black" align="center" position="0 0 0"></a-text>
      </a-entity>
      <a-entity id="raccoonEntity" mindar-image-target="targetIndex: 1">
          <a-image src="https://raw.githubusercontent.com/Rayasd396kr/ar/main/a.png" position="0 1.2 0" scale="0.75 0.75 0.75"></a-image>
          <a-text id="clickable" value="Zcl" color="black" align="center"  position="0 -0.5 0"></a-text>
          <a-gltf-model rotation="0 0 0 " position="0 -0.25 0" scale="1 1 1" src="https://raw.githubusercontent.com/Rayasd396kr/ar/main/zcl.glb" animation-mixer></a-gltf-model>
          <a-box id="button-left" class="clickable" color="black" width="0.7" height="0.3" depth="0.2" position="0 -0.8 0">
            <a-text value="introduce" align="center" color="white" position="0 0 0.1" scale="0.5 0.5 0.5"></a-text>
          </a-box>
      </a-entity>
    </a-scene>
    <div id="map"></div>
  </body>
  <script>
    const buttonleft = document.querySelector('#button-left');
    buttonleft.addEventListener("click", event => {
        window.parent.postMessage({ action: 'navigate', url: '/introduce' }, '*');
    });

    var map = L.map('map').setView([24.150445762526548, 120.68275085981597], 18);

    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });
    osm.addTo(map);

    var campusRoute = [
        [24.151316720437045, 120.68216157777869],
        [24.151350984453767, 120.68313253740402],
        [24.151249712100967, 120.68396645870185],
        [24.15054174566227, 120.68403863341727],
        [24.149779946928522, 120.68366843184863],
        [24.14995021318592, 120.68321549415676],
        [24.150025005025668, 120.68248712721095],
        [24.150381739416552, 120.68299739471283],
    ];

    function findClosestPoint(latlng, points) {
        let closestPoint = points[0];
        let minDistance = map.distance(latlng, closestPoint);
        
        for (let i = 1; i < points.length; i++) {
            let distance = map.distance(latlng, points[i]);
            if (distance < minDistance) {
                minDistance = distance;
                closestPoint = points[i];
            }
        }
        
        return closestPoint;
    }

    var polyline = L.polyline(campusRoute, {color: 'blue'}).addTo(map);

    
    var lc = L.control.locate({
        setView: 'always',  
        keepCurrentZoomLevel: true,  
        locateOptions: {
            enableHighAccuracy: true  
        },
        initialZoomLevel: 20  
    }).addTo(map);

    var currentIndex = 0;
    function onLocationFound(e) {
        var latlng = e.latlng;
        
        if (currentIndex === 0) {
            let closestPoint = findClosestPoint(latlng, campusRoute);
            currentIndex = campusRoute.indexOf(closestPoint);
        }

        campusRoute[currentIndex] = [latlng.lat, latlng.lng];

        polyline.setLatLngs(campusRoute);

        if (currentIndex > 0) {
            campusRoute.shift();
            polyline.setLatLngs(campusRoute);
        }

        currentIndex++;

        
        map.fitBounds(polyline.getBounds());
    }

    map.on('locationfound', onLocationFound);

    
    lc.start();
  </script>
</html>
