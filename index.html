<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenLayers 的地理位置和方向</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" type="text/css">
  <style>
    .map {
      height: 100vh;
      width: 100%;
    }
    .user-marker {
      width: 50px;
      height: 50px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="red" d="M12 2l9 21h-18l9-21z"/></svg>') no-repeat center;
      background-size: cover;
      transform-origin: center;
      transition: transform 0.2s ease; /* 平滑過渡效果 */
    }
    #calibration-message {
      display: none;
      position: fixed;
      bottom: 1em;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 1em;
      border-radius: 4px;
      z-index: 1000;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div id="map" class="map"></div>
  <div id="calibration-message">請通過在設備上做「8」字形移動來校準指南針。</div>
  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    const view = new ol.View({
      center: ol.proj.fromLonLat([120.68146003039392, 24.151017427806234]), // 初始位置
      zoom: 15
    });

    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],
      view: view,
      controls: [] // 明確移除所有預設控制項
    });

    const userIconElement = document.createElement('div');
    userIconElement.className = 'user-marker';

    const userMarker = new ol.Overlay({
      positioning: 'center-center',
      element: userIconElement,
      stopEvent: false
    });
    map.addOverlay(userMarker);

    const updateUserPosition = (coords) => {
      const { latitude, longitude } = coords;
      const position = ol.proj.fromLonLat([longitude, latitude]);
      userMarker.setPosition(position);
      view.setCenter(position);
      console.log(`用戶位置更新為: ${latitude}, ${longitude}`);
    };

    const geolocation = new ol.Geolocation({
      trackingOptions: {
        enableHighAccuracy: true,
      },
      projection: view.getProjection()
    });

    geolocation.on('change:position', () => {
      const position = geolocation.getPosition();
      if (position) {
        const coords = ol.proj.toLonLat(position);
        updateUserPosition({ latitude: coords[1], longitude: coords[0] });
      } else {
        console.error('獲取地理位置失敗。');
      }
    });

    // 啟用地理定位跟蹤
    geolocation.setTracking(true);

    const updateOrientation = (alpha) => {
      // alpha 是設備相對於地球磁北的方位角，範圍是 0 到 360 度
      userIconElement.style.transform = `rotate(${alpha}deg)`;
      console.log(`設備方向 alpha: ${alpha}`);
    };

    const handleOrientationEvent = (event) => {
      const alpha = event.alpha; // 絕對方位角
      if (alpha !== null) {
        updateOrientation(alpha);
      } else {
        console.error('Alpha 值為 null。');
      }
    };

    const initializeOrientation = () => {
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(permissionState => {
          if (permissionState === 'granted') {
            window.addEventListener('deviceorientationabsolute', handleOrientationEvent);
          } else {
            console.error('未授予設備方向權限。');
          }
        }).catch(console.error);
      } else {
        window.addEventListener('deviceorientationabsolute', handleOrientationEvent);
        window.addEventListener('deviceorientation', handleOrientationEvent); // 用於其他設備
      }
    };

    // 頁面加載時初始化設備方向
    window.addEventListener('load', initializeOrientation);

    // 指南針校準事件處理
    window.addEventListener("compassneedscalibration", function(event) {
      event.preventDefault();
      document.getElementById('calibration-message').style.display = 'block';
    });

    document.getElementById('calibration-message').addEventListener('click', function() {
      this.style.display = 'none';
    });
  </script>
</body>
</html>
