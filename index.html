<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geolocation and Orientation with OpenLayers</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" type="text/css">
  <style>
    .map {
      height: 100vh;
      width: 100%;
    }
    .user-marker {
      width: 50px;
      height: 50px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="red" d="M12 2l9 21h-18l9-21z"/></svg>') no-repeat center;
      background-size: cover;
      transform-origin: center;
    }
    #calibration-message {
      display: none;
      position: fixed;
      bottom: 1em;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 1em;
      border-radius: 4px;
      z-index: 1000;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div id="map" class="map"></div>
  <div id="calibration-message">Please calibrate your compass by moving your device in a figure-8 motion.</div>
  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    const view = new ol.View({
      center: ol.proj.fromLonLat([0, 0]),
      zoom: 15
    });

    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],
      view: view
    });

    const userIconElement = document.createElement('div');
    userIconElement.className = 'user-marker';

    const userMarker = new ol.Overlay({
      positioning: 'center-center',
      element: userIconElement,
      stopEvent: false
    });
    map.addOverlay(userMarker);

    const updateUserPosition = (coords) => {
      const { latitude, longitude } = coords;
      const position = ol.proj.fromLonLat([longitude, latitude]);
      userMarker.setPosition(position);
      view.setCenter(position);
      console.log(`User position updated to: ${latitude}, ${longitude}`);
    };

    const geolocation = new ol.Geolocation({
      trackingOptions: {
        enableHighAccuracy: true,
      },
      projection: view.getProjection()
    });

    geolocation.on('change:position', () => {
      const position = geolocation.getPosition();
      if (position) {
        const coords = ol.proj.toLonLat(position);
        updateUserPosition({ latitude: coords[1], longitude: coords[0] });
      } else {
        console.error('Failed to get geolocation position.');
      }
    });

    // 自動啟用地理定位跟蹤
    geolocation.setTracking(true);

    const updateOrientation = (alpha) => {
      userIconElement.style.transform = `rotate(${alpha}deg)`;
      console.log(`Device orientation alpha: ${alpha}`);
    };

    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      DeviceOrientationEvent.requestPermission().then(permissionState => {
        if (permissionState === 'granted') {
          window.addEventListener('deviceorientationabsolute', (event) => {
            const alpha = event.alpha; // 絕對方位角
            if (alpha !== null) {
              updateOrientation(alpha);
            } else {
              console.error('Alpha value is null.');
            }
          });
        } else {
          console.error('Device orientation permission not granted.');
        }
      }).catch(console.error);
    } else {
      window.addEventListener('deviceorientationabsolute', (event) => {
        const alpha = event.alpha; // 絕對方位角
        if (alpha !== null) {
          updateOrientation(alpha);
        } else {
          console.error('Alpha value is null.');
        }
      });
    }

    // 指南針校準事件處理
    window.addEventListener("compassneedscalibration", function(event) {
      event.preventDefault();
      document.getElementById('calibration-message').style.display = 'block';
    });

    document.getElementById('calibration-message').addEventListener('click', function() {
      this.style.display = 'none';
    });

  </script>
</body>
</html>
