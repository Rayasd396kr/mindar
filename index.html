<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR Geolocation</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component/dist/aframe-look-at-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;">
      
      <!-- 添加 3D 物件 -->
      <a-box id="targetBox" position="0 0 0" material="color: red;" visible="false" look-at="[gps-camera]"></a-box>

      <a-camera id="gps-camera" gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      // 計算兩點之間的距離（Haversine公式）
      function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000; // 地球半徑（米）
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c;
        return distance;
      }

      // 設置目標位置
      const targetLat = 24.151017427806234;
      const targetLon = 120.68146003039392;

      // 檢查距離並顯示或隱藏物件
      navigator.geolocation.watchPosition(function(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        const distance = getDistanceFromLatLonInMeters(userLat, userLon, targetLat, targetLon);
        const box = document.getElementById('targetBox');
        const camera = document.getElementById('gps-camera');

        if (distance < 50) {
          // 設定物件顯示在相機前方 2 米處
          const cameraPosition = camera.getAttribute('position');
          const cameraRotation = camera.getAttribute('rotation');
          
          const radianRotation = cameraRotation.y * Math.PI / 180;
          const offsetX = Math.sin(radianRotation) * 2;
          const offsetZ = Math.cos(radianRotation) * 2;
          
          box.setAttribute('position', {
            x: cameraPosition.x + offsetX,
            y: cameraPosition.y,
            z: cameraPosition.z - offsetZ
          });
          box.setAttribute('visible', 'true');
          box.setAttribute('look-at', '[gps-camera]'); // 確保物件始終朝向相機
        } else {
          box.setAttribute('visible', 'false');
        }
      }, function(error) {
        console.error('Geolocation error:', error);
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 27000
      });

      // 檢查方向感應器
      window.addEventListener('deviceorientation', function(event) {
        if (event.alpha === null) {
          console.warn('Device orientation not supported or not enabled.');
        } else {
          console.log('Device orientation available.');
        }
      });
    </script>
  </body>
</html>
