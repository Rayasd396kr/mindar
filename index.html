<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v6.1.0/dist/aframe-extras.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@v0.74.0/dist/L.Control.Locate.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.74.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 30vh;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 999;
            transition: height 0.5s;
        }
        .custom-div-icon {
            text-align: center;
            font-size: 15px;
        }
        .custom-div-icon .circle {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 15px;
            height: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #000;
            margin-bottom: 2px;
        }
        .custom-div-icon .text {
            position: relative;
            left: -15px;
        }
        .info-window {
            position: fixed;
            bottom: 31%;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            display: none;
            z-index: 1000;
            box-sizing: border-box;
            overflow: auto;
        }
        .info-window img {
            width: 80px;
            height: 80px;
            float: left;
            margin-right: 10px;
        }
        .info-window h3 {
            margin: 0;
        }
        .info-window p {
            margin: 5px 0;
        }
        .info-window button {
            display: block;
            margin-top: 10px;
        }
        .button-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            position: fixed;
            top: 10px;
            width: 100%;
            overflow-x: auto;
            z-index: 1001;
            white-space: nowrap;
            padding: 10px 0;
            box-sizing: border-box;
        }
        .button-container button {
            margin: 0 10px;
            padding: 10px 20px;
            border: none;
            background-color: #307fb7;
            color: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            flex-shrink: 0;
        }
        .button-container::-webkit-scrollbar {
            display: none;
        }
        .zoom-button {
            position: absolute;
            bottom: 40px;
            right: 10px;
            z-index: 1000;
            background-color: #307fb7;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            font-size: 16px;
        }
        .content {
            padding: 20px;
            padding-top: 70vh;
            background: #f0f0f0;
            height: 100%;
            box-sizing: border-box;
            z-index: 1002;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="button-container">
        <button onclick="navigation()">導覽路線</button>
        <button onclick="showBuildings()">大樓</button>
        <button onclick="showOffices()">處室</button>
        <button onclick="showSports()">運動場</button>
        <button onclick="showEvents()">活動</button>
    </div>

    <a-scene mindar-image="uiScanning: #example-scanning-overlay;filterMinCF:0.0001; filterBeta: 0.001;imageTargetSrc: https://raw.githubusercontent.com/Rayasd396kr/ar/main/t3.mind;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: ${customFields.libVersion}; objects: .clickable"></a-camera>
        <a-entity id="bearEntity" mindar-image-target="targetIndex: 0">
            <a-plane opacity="0.5" color="white" width="10" height="10" position="0 0 0"></a-plane>
            <a-text value="test" color="black" align="center" position="0 0 0"></a-text>
        </a-entity>
        <a-entity id="raccoonEntity" mindar-image-target="targetIndex: 1">
            <a-image src="https://raw.githubusercontent.com/Rayasd396kr/ar/main/a.png" position="0 1.2 0" scale="0.75 0.75 0.75"></a-image>
            <a-text id="clickable" value="Zcl" color="black" align="center" position="0 -0.5 0"></a-text>
            <a-gltf-model rotation="0 0 0 " position="0 -0.25 0" scale="1 1 1" src="https://raw.githubusercontent.com/Rayasd396kr/ar/main/zcl.glb" animation-mixer></a-gltf-model>
            <a-box id="button-left" class="clickable" color="black" width="0.7" height="0.3" depth="0.2" position="0 -0.8 0">
                <a-text value="introduce" align="center" color="white" position="0 0 0.1" scale="0.5 0.5 0.5"></a-text>
            </a-box>
        </a-entity>
        <a-entity>
            <a-box position="0 1.5 0" rotation="0 45 45" color="#4CC3D9"></a-box>
            <a-text value="Hello, AR World!" position="0 2 0" rotation="0 0 0" align="center" color="#FFFFFF"></a-text>
        </a-entity>
    </a-scene>

    <div id="map"></div>
    <div id="info-window" class="info-window">
        <img id="info-image" src="" alt="Info Image">
        <div>
            <h3 id="info-title">Title</h3>
            <p id="info-description">Description</p>
            <button id="info-button">Learn More</button>
        </div>
    </div>
    <button class="zoom-button" onclick="toggleFullScreen()">放大地圖</button>

    <script>
        var map = L.map('map').setView([24.150996625919188, 120.68148734742584], 18);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var infoImage = document.getElementById('info-image');
        var infoTitle = document.getElementById('info-title');
        var infoDescription = document.getElementById('info-description');
        var infoButton = document.getElementById('info-button');
        var infoWindow = document.getElementById('info-window');

        var locations = [
            { circle: "1", name: "行政&資訊樓", coords: [24.14961330934904, 120.68364591589136], image: 'https://raw.githubusercontent.com/Rayasd396kr/ar/main/zcl.png', title: '行政&資訊樓', description: '行政&資訊樓的描述', buttonText: '集點' },
            { circle: "2", name: "中正樓", coords: [24.14960142559353, 120.68333783333679], image: 'https://example.com/image2.jpg', title: '中正樓', description: '中正樓的描述', buttonText: '了解更多' },
            { circle: "3", name: "活動中心", coords: [24.15002756948417, 120.68259788356026], image: 'https://example.com/image3.jpg', title: '活動中心', description: '活動中心的描述', buttonText: '了解更多' },
            { circle: "4", name: "昌明樓", coords: [24.150397919894687, 120.68298858486425] },
            { circle: "5", name: "翰英樓", coords: [24.151290909932047, 120.68315169317616] },
            { circle: "6", name: "中商大樓", coords: [24.15123377909032, 120.68217149067684] },
            { circle: "7", name: "宿舍", coords: [24.151830165086253, 120.68329357159718] },
            { circle: "8", name: "奇秀樓", coords: [24.151224781813994, 120.68397935752898] },
            { circle: "9", name: "弘業樓", coords: [24.1505058854478, 120.68404953097337] },
            { circle: "10", name: "home", coords: [24.150996625919188, 120.68148734742584], image: 'https://raw.githubusercontent.com/Rayasd396kr/ar/main/zcl.png', title: 'home', description: '家的描述', buttonText: '集點' },
        ];

        locations.forEach(location => {
            var textMarker = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class='circle'>${location.circle}</div><div class='text'>${location.name}</div>`,
                iconSize: [50, 50],
                iconAnchor: [15, 0]
            });

            L.marker(location.coords, { icon: textMarker }).addTo(map);
        });

        var lc = L.control.locate({
            setView: 'always',
            keepCurrentZoomLevel: true,
            locateOptions: {
                enableHighAccuracy: true
            },
            initialZoomLevel: 20
        }).addTo(map);

        lc.start();

        var userLatLng = [24.150996625919188, 120.68148734742584]; // 初始用户位置

        function updateInfoWindow(latlng) {
            var closestLocation = locations.reduce((closest, location) => {
                var distance = map.distance(latlng, location.coords);
                return distance < closest.distance ? { location, distance } : closest;
            }, { distance: Infinity }).location;

            if (map.distance(latlng, closestLocation.coords) < 50) { 
                infoImage.src = closestLocation.image;
                infoTitle.textContent = closestLocation.title;
                infoDescription.textContent = closestLocation.description;
                infoButton.textContent = closestLocation.buttonText;
                infoButton.onclick = () => alert('Button clicked!');
                infoWindow.style.display = 'block';
            } else {
                infoWindow.style.display = 'none';
            }
        }

        map.on('locationfound', function(e) {
            userLatLng = [e.latlng.lat, e.latlng.lng];
            updateInfoWindow(e.latlng);
        });

        var initialCenter = [24.150068244137064, 120.68247776551931];

        function toggleFullScreen() {
            const mapElement = document.getElementById('map');
            if (mapElement.style.height === '100vh') {
                mapElement.style.height = '30vh';
                setTimeout(() => {
                    map.invalidateSize(); // 确保地图更新大小
                    map.setView(userLatLng, map.getZoom()); // 重新设置中心点为用户位置
                }, 500); // 等待过渡完成
                document.querySelector('.content').style.paddingTop = '30vh'; // 恢复内容的 padding-top
            } else {
                mapElement.style.height = '100vh';
                mapElement.style.position = 'fixed';
                document.querySelector('.content').style.paddingTop = '100vh'; // 增加内容的 padding-top
                setTimeout(() => {
                    map.invalidateSize(); // 确保地图更新大小
                    map.setView(userLatLng, map.getZoom()); // 重新设置中心点为用户位置
                }, 500); // 等待过渡完成
            }
        }
    </script>
</body>
</html>
